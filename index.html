<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Please Find Your Seat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Abel&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Abel', sans-serif;
            font-weight: 800;
            background-color: #8cabc0;
        }
        body.modal-open {
            overflow: hidden;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-card {
            background-color: #8cabc0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            max-width: 80%;
            max-height: 80%;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
        }
        .modal-card img {
            max-width: 100%;
            max-height: 60%;
            object-fit: contain;
        }
        .modal-card .loading {
            color: #d9e5f9;
            font-size: 1.25rem;
            font-weight: 800;
        }
        .table-card {
            background-color: #d9e5f9;
            color: #8cabc0;
            width: 100%;
            max-width: 280px;
            padding: 10px;
            margin-top: 10px;
            border-radius: 8px;
            text-align: center;
            overflow: hidden;
            position: relative;
            touch-action: pan-x;
        }
        .table-card h3 {
            font-size: 1.25rem;
            font-weight: 800;
            margin-bottom: 8px;
        }
        .table-card .name-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
            overflow: hidden;
        }
        .table-card .name {
            position: absolute;
            width: 100%;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .table-card .name.active {
            opacity: 1;
        }
        .search-container {
            position: relative;
            width: 100%;
        }
        .search-image-container {
            position: relative;
            width: 280px;
            margin: 8px auto 0;
            display: none;
        }
        .search-image-container.visible {
            display: block;
        }
        .search-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            max-width: 280px;
            object-fit: contain;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 1;
        }
        .search-image.active {
            opacity: 1;
            z-index: 2;
        }
        .clear-button {
            position: absolute;
            right: 16px;
            top: 13px;
            color: #8cabc0;
            font-size: 1rem;
            font-weight: 800;
            cursor: pointer;
            display: none;
        }
        .search-container input:not(:placeholder-shown) + .clear-button {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-12">
        <h1 class="text-4xl font-extrabold text-center mb-8" style="color: #d9e5f9;">Please Find Your Seat</h1>
        <div class="max-w-lg mx-auto">
            <div class="search-container">
                <input
                    type="text"
                    id="searchInput"
                    placeholder="Type your name..."
                    class="w-full px-4 py-2 mb-6 border rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-[#8cabc0] text-[#8cabc0] placeholder-[#8cabc0] font-extrabold text-base"
                    style="background-color: #d9e5f9;"
                >
                <span class="clear-button">Ã—</span>
                <div class="search-image-container" id="searchImageContainer"></div>
            </div>
            <div id="results" class="flex flex-wrap gap-3 justify-center"></div>
        </div>
    </div>
    <div id="modal" class="modal-overlay hidden"></div>

    <script>
        let guestsData = [];
        let rotationInterval = null;

        async function imageExists(url) {
            try {
                const response = await fetch(url, { method: 'HEAD' });
                return response.ok;
            } catch {
                return false;
            }
        }

        async function loadMainImages() {
            const container = document.getElementById('searchImageContainer');
            const loadedImages = [];

            const loadFirstImage = async () => {
                const src = (await imageExists('images/home/1.png')) ? 'images/home/1.png' : 
                            (await imageExists('images/home/1.jpg')) ? 'images/home/1.jpg' : null;
                if (!src) return null;
                return new Promise((resolve) => {
                    const img = new Image();
                    img.src = src;
                    img.alt = 'Main seating chart 1';
                    img.className = 'search-image active';
                    img.onload = () => {
                        container.appendChild(img);
                        if (!document.getElementById('searchInput').value) {
                            container.classList.add('visible');
                        }
                        resolve(img);
                    };
                    img.onerror = () => resolve(null);
                });
            };

            const firstImage = await loadFirstImage();
            if (firstImage) loadedImages.push(firstImage);

            const imagePromises = [];
            for (let i = 2; i <= 10; i++) {
                imagePromises.push((async () => {
                    const src = (await imageExists(`images/home/${i}.png`)) ? `images/home/${i}.png` : 
                                (await imageExists(`images/home/${i}.jpg`)) ? `images/home/${i}.jpg` : null;
                    if (!src) return null;
                    return new Promise((resolve) => {
                        const img = new Image();
                        img.src = src;
                        img.alt = `Main seating chart ${i}`;
                        img.className = 'search-image';
                        img.onload = () => {
                            container.appendChild(img);
                            resolve(img);
                        };
                        img.onerror = () => resolve(null);
                    });
                })());
            }

            const remainingImages = (await Promise.all(imagePromises)).filter(img => img);
            loadedImages.push(...remainingImages);

            if (loadedImages.length > 1 && !document.getElementById('searchInput').value) {
                startRotation();
            }
        }

        function startRotation() {
            stopRotation();
            const images = Array.from(document.querySelectorAll('.search-image'));
            if (images.length <= 1) return;
            let currentIndex = 0;
            rotationInterval = setInterval(() => {
                if (document.getElementById('searchInput').value) {
                    stopRotation();
                    return;
                }
                images.forEach((img, index) => img.classList.toggle('active', index === currentIndex));
                currentIndex = (currentIndex + 1) % images.length;
            }, 3000);
        }

        function stopRotation() {
            if (rotationInterval) {
                clearInterval(rotationInterval);
                rotationInterval = null;
            }
        }

        async function loadGuests() {
            try {
                const response = await fetch('seating-chart.csv');
                if (!response.ok) throw new Error('CSV load failed');
                const csvText = await response.text();
                guestsData = Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    transform: (value) => value.trim().replace(/^"|"$/g, '')
                }).data.map(row => ({
                    fullName: `${row["First Name"] || ""} ${row["Last Name"] || ""}`.trim(),
                    display: `${row["First Name"] || ""} ${row["Last Name"] || ""} | Table ${row["Table"]}`,
                    table: row["Table"]
                }));
                loadMainImages();
                return guestsData;
            } catch {
                document.getElementById('results').innerHTML = `
                    <div class="px-4 py-1.5 text-[#8cabc0] font-extrabold text-base flex items-center justify-center"
                         style="background-color: #d9e5f9; white-space: nowrap; width: 280px; height: 32px;">
                        Unable to load guest list
                    </div>`;
                return [];
            }
        }

        function showModal(tableNumber) {
            const modal = document.getElementById('modal');
            const tableGuests = guestsData
                .filter(guest => guest.table === tableNumber)
                .map(guest => guest.fullName);
            
            let currentIndex = 0;
            let touchStartX = 0;

            const modalContent = `
                <div class="modal-card">
                    <div class="loading">Loading image...</div>
                    <img src="images/tables/Table ${tableNumber}.png" alt="Table ${tableNumber} layout"
                         onload="this.previousElementSibling.remove()"
                         onerror="this.previousElementSibling.textContent='Failed to load image'">
                    <div class="table-card">
                        <h3>Table ${tableNumber}</h3>
                        <div class="name-container">
                            ${tableGuests.map((name, index) => `
                                <div class="name ${index === 0 ? 'active' : ''}">${name}</div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            modal.innerHTML = modalContent;
            modal.classList.remove('hidden');
            document.body.classList.add('modal-open');

            const nameContainer = modal.querySelector('.name-container');
            if (!nameContainer) return;

            function updateNameDisplay() {
                const names = nameContainer.querySelectorAll('.name');
                names.forEach((name, index) => {
                    name.classList.toggle('active', index === currentIndex);
                });
            }

            nameContainer.addEventListener('touchstart', e => {
                touchStartX = e.touches[0].clientX;
            });

            nameContainer.addEventListener('touchend', e => {
                const touchEndX = e.changedTouches[0].clientX;
                const deltaX = touchEndX - touchStartX;
                if (deltaX > 50 && currentIndex > 0) {
                    currentIndex--;
                    updateNameDisplay();
                } else if (deltaX < -50 && currentIndex < tableGuests.length - 1) {
                    currentIndex++;
                    updateNameDisplay();
                }
            });
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            modal.classList.add('hidden');
            modal.innerHTML = '';
            document.body.classList.remove('modal-open');
        }

        function updateResults(query, guests) {
            const resultsList = document.getElementById('results');
            const imageContainer = document.getElementById('searchImageContainer');
            resultsList.innerHTML = '';
            
            if (!query) {
                imageContainer.classList.add('visible');
                startRotation();
                resultsList.innerHTML = '';
                return;
            }

            imageContainer.classList.remove('visible');
            stopRotation();

            const filteredGuests = guests.filter(guest =>
                guest.fullName.toLowerCase().includes(query.toLowerCase())
            );

            if (!filteredGuests.length) {
                resultsList.innerHTML = `
                    <div class="px-4 py-1.5 text-[#8cabc0] font-extrabold text-base flex items-center justify-center"
                         style="background-color: #d9e5f9; white-space: nowrap; width: 280px; height: 32px;">
                        No matching guests found
                    </div>`;
                return;
            }

            filteredGuests.forEach(guest => {
                const div = document.createElement('div');
                div.className = 'px-4 py-1.5 rounded-full shadow-sm text-[#8cabc0] text-xl font-extrabold flex items-center justify-center cursor-pointer';
                div.style.backgroundColor = '#d9e5f9';
                div.style.whiteSpace = 'nowrap';
                div.style.width = '280px';
                div.style.height = '32px';
                div.textContent = guest.display;
                div.onclick = () => showModal(guest.table);
                resultsList.appendChild(div);
            });
        }

        loadGuests().then(guests => {
            document.getElementById('searchInput').addEventListener('input', e => updateResults(e.target.value, guests));
            document.querySelector('.clear-button').addEventListener('click', () => {
                document.getElementById('searchInput').value = '';
                document.getElementById('searchInput').dispatchEvent(new Event('input'));
            });
        });

        document.addEventListener('click', e => {
            if (e.target.classList.contains('modal-overlay')) closeModal();
        });
    </script>
</body>
</html>
