<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Please Find Your Seat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Abel&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Abel', sans-serif;
            font-weight: 800;
        }
        body.modal-open {
            overflow: hidden;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-card {
            background-color: #8cabc0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            max-width: 80%;
            max-height: 80%;
            min-width: 300px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        .modal-card img {
            max-width: 100%;
            max-height: 60%;
            object-fit: contain;
        }
        .modal-card .loading {
            color: #d9e5f9;
            font-size: 1.25rem;
            font-weight: 800;
            text-align: center;
        }
        .name-card {
            background-color: #d9e5f9;
            color: #8cabc0;
            width: 100%;
            max-width: 280px;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            touch-action: pan-x;
        }
        .name-card.active {
            opacity: 1;
        }
        .name-card h3 {
            font-size: 1.25rem;
            font-weight: 800;
            margin-bottom: 8px;
        }
        .name-card .name {
            font-size: 1rem;
            font-weight: 800;
        }
        .search-container {
            position: relative;
            width: 100%;
        }
        .search-image-container {
            position: relative;
            width: 280px;
            margin: 8px auto 0;
            display: none;
        }
        .search-image-container.visible {
            display: block;
        }
        .search-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            max-width: 280px;
            object-fit: contain;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 1;
        }
        .search-image.active {
            opacity: 1;
            z-index: 2;
        }
        .clear-button {
            position: absolute;
            right: 16px;
            top: 13px;
            line-height: 1;
            color: #8cabc0;
            font-size: 1rem;
            font-weight: 800;
            cursor: pointer;
            display: none;
        }
        .search-container input:not(:placeholder-shown) + .clear-button {
            display: block;
        }
    </style>
</head>
<body style="background-color: #8cabc0;">
    <div class="container mx-auto px-4 py-12">
        <h1 class="text-4xl font-extrabold text-center mb-8" style="color: #d9e5f9;">Please Find Your Seat</h1>
        <div class="max-w-lg mx-auto">
            <div class="search-container">
                <input
                    type="text"
                    id="searchInput"
                    placeholder="Type your name..."
                    class="w-full px-4 py-2 mb-6 border rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-[#8cabc0] text-[#8cabc0] placeholder-[#8cabc0] font-extrabold text-base"
                    style="background-color: #d9e5f9;"
                >
                <span class="clear-button">Ã—</span>
                <div class="search-image-container" id="searchImageContainer"></div>
            </div>
            <div id="results" class="flex flex-wrap gap-3 justify-center"></div>
        </div>
    </div>
    <div id="modal" class="modal-overlay hidden"></div>

    <script>
        let guestsData = [];
        let currentTable = null;
        let isImageView = true;
        let currentNameIndex = 0;
        let imageRotationInterval = null;
        let lastRotationIndex = 0;

        async function imageExists(url) {
            try {
                const response = await fetch(url, { method: 'HEAD' });
                return response.ok;
            } catch {
                return false;
            }
        }

        async function loadMainImages() {
            const container = document.getElementById('searchImageContainer');
            const maxImages = 10;
            const imagePromises = [];

            for (let i = 1; i <= maxImages; i++) {
                imagePromises.push((async () => {
                    const src = (await imageExists(`images/home/${i}.png`)) ? `images/home/${i}.png` :
                                (await imageExists(`images/home/${i}.jpg`)) ? `images/home/${i}.jpg` : null;
                    if (!src) return null;
                    return { index: i, src };
                })());
            }

            const imageResults = (await Promise.all(imagePromises)).filter(result => result);
            imageResults.sort((a, b) => a.index - b.index);

            const loadedImages = [];
            for (const result of imageResults) {
                const img = await new Promise((resolve) => {
                    const image = new Image();
                    image.src = result.src;
                    image.alt = `Main seating chart ${result.index}`;
                    image.className = `search-image ${loadedImages.length === 0 ? 'active' : ''}`;
                    image.onload = () => {
                        container.appendChild(image);
                        resolve(image);
                    };
                    image.onerror = () => resolve(null);
                });
                if (img) loadedImages.push(img);
            }

            if (loadedImages.length > 0 && !document.getElementById('searchInput').value) {
                container.classList.add('visible');
                if (loadedImages.length > 1) {
                    startOrResumeRotation();
                }
            }
        }

        function startOrResumeRotation() {
            stopImageRotation();
            const images = Array.from(document.querySelectorAll('.search-image'));
            if (images.length <= 1) return;
            rotateImages(images, lastRotationIndex);
        }

        function rotateImages(images, currentIndex) {
            const input = document.getElementById('searchInput');
            if (input.value.length > 0) return;
            images.forEach((img, index) => {
                img.classList.toggle('active', index === currentIndex);
            });
            lastRotationIndex = (currentIndex + 1) % images.length;
            imageRotationInterval = setTimeout(() => {
                rotateImages(images, lastRotationIndex);
            }, 3000);
        }

        function stopImageRotation() {
            if (imageRotationInterval) {
                clearTimeout(imageRotationInterval);
                imageRotationInterval = null;
            }
        }

        async function loadGuests() {
            try {
                const response = await fetch('seating-chart.csv');
                if (!response.ok) throw new Error('CSV load failed');
                const csvText = await response.text();
                guestsData = Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    transform: (value) => value.trim().replace(/^"|"$/g, '')
                }).data.map(row => ({
                    fullName: `${row["First Name"] || ""} ${row["Last Name"] || ""}`.trim(),
                    display: `${row["First Name"] || ""} ${row["Last Name"] || ""} | Table ${row["Table"]}`,
                    table: row["Table"]
                }));
                loadMainImages();
                return guestsData;
            } catch (error) {
                console.error('Error loading CSV:', error);
                document.getElementById('results').innerHTML = `
                    <div class="px-4 py-1.5 text-[#8cabc0] font-extrabold text-base flex items-center justify-center"
                         style="background-color: #d9e5f9; white-space: nowrap; width: 280px; height: 32px;">
                        Unable to load guest list
                    </div>`;
                return [];
            }
        }

        function showModal(tableNumber, view = 'image') {
            currentTable = tableNumber;
            isImageView = view === 'image';
            currentNameIndex = 0;
            const modal = document.getElementById('modal');
            const tableGuests = guestsData
                .filter(guest => guest.table === tableNumber)
                .map(guest => guest.fullName);

            const modalContent = `
                <div class="modal-card">
                    <div class="loading">Loading image...</div>
                    <img src="images/tables/Table ${tableNumber}.png" alt="Table ${tableNumber} layout"
                         onload="this.previousElementSibling.remove()"
                         onerror="this.previousElementSibling.textContent='Failed to load image'; console.error('Failed to load image: images/tables/Table ${tableNumber}.png')"
                         class="${isImageView ? 'active' : ''}">
                    ${tableGuests.map((name, index) => `
                        <div class="name-card ${view === 'guests' && index === 0 ? 'active' : ''}">
                            <h3>Table ${tableNumber}</h3>
                            <div class="name">${name}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            modal.innerHTML = modalContent;
            modal.classList.remove('hidden');
            document.body.classList.add('modal-open');

            const modalCard = modal.querySelector('.modal-card');
            if (!modalCard) return;

            let touchStartX = 0;
            modalCard.addEventListener('touchstart', e => {
                touchStartX = e.touches[0].clientX;
            });

            modalCard.addEventListener('touchend', e => {
                const touchEndX = e.changedTouches[0].clientX;
                const deltaX = touchEndX - touchStartX;
                if (Math.abs(deltaX) > 50) {
                    if (isImageView) {
                        if (tableGuests.length > 0) {
                            showModal(tableNumber, 'guests');
                        }
                    } else {
                        if (deltaX > 50 && currentNameIndex > 0) {
                            currentNameIndex--;
                            updateNameDisplay();
                        } else if (deltaX < -50 && currentNameIndex < tableGuests.length - 1) {
                            currentNameIndex++;
                            updateNameDisplay();
                        } else if (deltaX < -50 && currentNameIndex === tableGuests.length - 1) {
                            showModal(tableNumber, 'image');
                        } else if (deltaX > 50 && currentNameIndex === 0) {
                            showModal(tableNumber, 'image');
                        }
                    }
                }
            });

            function updateNameDisplay() {
                const cards = modalCard.querySelectorAll('.name-card');
                cards.forEach((card, index) => {
                    card.classList.toggle('active', index === currentNameIndex);
                });
            }
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            modal.classList.add('hidden');
            modal.innerHTML = '';
            currentTable = null;
            isImageView = true;
            currentNameIndex = 0;
            document.body.classList.remove('modal-open');
        }

        function updateResults(query, guests) {
            const resultsList = document.getElementById('results');
            const imageContainer = document.getElementById('searchImageContainer');
            resultsList.innerHTML = '';

            if (query.length === 0) {
                imageContainer.classList.add('visible');
                startOrResumeRotation();
                return;
            }

            imageContainer.classList.remove('visible');
            stopImageRotation();

            const filteredGuests = guests.filter(guest =>
                guest.fullName.toLowerCase().includes(query.toLowerCase())
            );

            if (filteredGuests.length === 0) {
                resultsList.innerHTML = `
                    <div class="px-4 py-1.5 text-[#8cabc0] font-extrabold text-base flex items-center justify-center"
                         style="background-color: #d9e5f9; white-space: nowrap; width: 280px; height: 32px;">
                        No matching guests found
                    </div>`;
                return;
            }

            filteredGuests.forEach(guest => {
                const div = document.createElement('div');
                div.className = 'px-4 py-1.5 rounded-full shadow-sm text-[#8cabc0] text-xl font-extrabold flex items-center justify-center cursor-pointer';
                div.style.backgroundColor = '#d9e5f9';
                div.style.whiteSpace = 'nowrap';
                div.style.width = '280px';
                div.style.height = '32px';
                div.textContent = guest.display;
                div.onclick = () => showModal(guest.table);
                resultsList.appendChild(div);
            });
        }

        loadGuests().then(guests => {
            document.getElementById('searchInput').addEventListener('input', e => updateResults(e.target.value, guests));
            document.querySelector('.clear-button').addEventListener('click', () => {
                document.getElementById('searchInput').value = '';
                document.getElementById('searchInput').dispatchEvent(new Event('input'));
            });
        });

        document.addEventListener('click', e => {
            if (e.target.classList.contains('modal-overlay')) closeModal();
        });
    </script>
</body>
</html>
